<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users & Roles | Admin Corner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Outfit:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Premium Auth Guard for Admins
        const checkAdminAuth = async () => {
            const SUPABASE_URL = 'https://aobwkcjfhbruihkandlg.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvYndrY2pmaGJydWloa2FuZGxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjE1MjAsImV4cCI6MjA4NzU5NzUyMH0.V7OdMoiiDuXIMOdoUDLlUMjdavSjObHpajb2gHh0E38';
            const tempSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session } } = await tempSupabase.auth.getSession();

            if (!session) {
                window.location.replace('index.html');
                return;
            }

            const { data: userData } = await tempSupabase.from('Access').select('role').ilike('email_id', session.user.email).single();
            if (!userData || userData.role !== 'Super admin') {
                window.location.replace('dashboard.html');
            } else {
                document.body.style.display = 'block';
            }
        };
        checkAdminAuth();
    </script>
    <style>
        body {
            display: none;
        }

        .admin-page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .users-table-container {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 1.5rem;
            backdrop-filter: blur(10px);
            /* Removed overflow: hidden to allow dropdown menus to show */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        th {
            background: rgba(255, 255, 255, 0.02);
            padding: 1.25rem 1.5rem;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--glass-border);
        }

        td {
            padding: 1.25rem 1.5rem;
            font-size: 0.95rem;
            color: var(--text-primary);
            border-bottom: 1px solid var(--glass-border);
        }

        tr:last-child td {
            border-bottom: none;
        }

        .role-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent-color);
            border: 1px solid rgba(56, 189, 248, 0.2);
        }

        .btn-add {
            background: var(--accent-color);
            color: #000;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: all 0.2s ease;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.3);
        }

        .search-container {
            margin-bottom: 2rem;
            position: relative;
            max-width: 400px;
        }

        .search-input {
            width: 100%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 1rem;
            padding: 0.8rem 1rem 0.8rem 3rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .action-cell {
            position: relative;
            text-align: center;
        }

        .three-dots-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .three-dots-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .action-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: #0f172a;
            border: 1px solid var(--glass-border);
            border-radius: 0.75rem;
            padding: 0.5rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.8);
            display: none;
            z-index: 1000;
            /* Higher priority */
            width: 180px;
            text-align: left;
        }

        .action-menu.active {
            display: block;
        }

        .action-menu-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.8rem;
            border-radius: 0.5rem;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            width: 100%;
            border: none;
            background: none;
            cursor: pointer;
        }

        .action-menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent-color);
        }

        .action-menu-item.danger {
            color: #ef4444;
        }

        .action-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .status-badge {
            padding: 0.35rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
    </style>
</head>

<body>
    <div class="dashboard-wrapper">
        <header class="top-header">
            <div class="header-left">
                <button id="sidebar-toggle-btn" class="sidebar-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="sidebar-logo">DBMCI One Mentorship</div>
            </div>
            <div class="header-actions">
                <div class="user-profile" id="user-profile-btn">
                    <div class="avatar">G</div>
                    <div class="profile-info">
                        <span class="name">Gourav</span>
                        <span class="role">Super admin</span>
                    </div>
                    <div class="profile-dropdown">
                        <a href="#" class="dropdown-item" id="open-profile-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            My Profile
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="#" id="logout-btn" class="dropdown-item logout">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                                <polyline points="16 17 21 12 16 7"></polyline>
                                <line x1="21" y1="12" x2="9" y2="12"></line>
                            </svg>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </header>
        <div class="dashboard-container">
            <aside class="sidebar">
                <nav class="sidebar-nav">
                    <div class="nav-group">Main Menu</div>
                    <a href="dashboard.html" class="nav-item">Homepage</a>
                    <a href="schedule.html" class="nav-item">Schedule</a>
                    <a href="#" class="nav-item">Book a Session</a>
                    <a href="#" class="nav-item">History</a>

                    <div class="admin-only" id="admin-section" style="display: block;">
                        <div class="nav-group">Admin Corner</div>
                        <a href="admin-users.html" class="nav-item active">Users & Roles</a>
                        <a href="upload-schedule.html" class="nav-item">Upload Schedule</a>
                        <a href="manage-centres.html" class="nav-item">Manage Centres</a>
                    </div>
                </nav>
            </aside>
            <main class="dashboard-main">
                <div class="admin-page-header">
                    <div>
                        <h1>Users & Roles</h1>
                        <p style="color: var(--text-secondary);">Manage your platform users and their permissions.</p>
                    </div>
                    <button class="btn-add"
                        onclick="document.getElementById('add-user-modal').classList.add('active')">+ Add User</button>
                </div>

                <div class="search-container">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="text" id="user-search" class="search-input" placeholder="Search by email or phone...">
                </div>

                <div class="users-table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Phone</th>
                                <th>Centre Name</th>
                                <th>Status</th>
                                <th style="text-align: center;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-body">
                            <!-- Data populated via JS -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <!-- Enhanced Add User Modal -->
    <div id="add-user-modal" class="modal-overlay">
        <div class="login-card" style="max-width: 600px; padding: 2.5rem;">
            <div class="header" style="margin-bottom: 2rem;">
                <h2>Add Users</h2>
                <p>Choose between manual entry or batch CSV upload</p>

                <div class="tab-switcher"
                    style="display: flex; gap: 1rem; margin-top: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 0.5rem;">
                    <button id="tab-manual" class="tab-btn active"
                        style="background: none; border: none; color: var(--accent-color); font-weight: 600; cursor: pointer; padding: 0.5rem 1rem; border-bottom: 2px solid var(--accent-color);">Manual
                        Entry</button>
                    <button id="tab-csv" class="tab-btn"
                        style="background: none; border: none; color: var(--text-secondary); font-weight: 600; cursor: pointer; padding: 0.5rem 1rem;">CSV
                        Upload</button>
                </div>
            </div>

            <!-- Manual Form -->
            <form id="add-user-form" class="tab-content">
                <div class="input-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="input-group">
                        <label>Full Name</label>
                        <input type="text" id="add-name" required placeholder="Gourav">
                    </div>
                    <div class="input-group">
                        <label>Email Address</label>
                        <input type="email" id="add-email" required placeholder="email@example.com">
                    </div>
                    <div class="input-group">
                        <label>Phone Number</label>
                        <input type="tel" id="add-phone" required placeholder="9007996101">
                    </div>
                    <div class="input-group">
                        <label>Role</label>
                        <select id="add-role" onchange="toggleCentreField()"
                            style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 0.75rem; padding: 0.875rem 1rem; color: var(--text-primary); width: 100%;">
                            <option value="Students">Students</option>
                            <option value="Mentor">Mentor</option>
                            <option value="Admin">Admin</option>
                            <option value="Academics">Academics</option>
                            <option value="Super admin">Super admin</option>
                        </select>
                    </div>
                    <div class="input-group" id="centre-group">
                        <label id="centre-label">Centre Name</label>
                        <select id="add-centre" class="centre-selector"
                            style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 0.75rem; padding: 0.875rem 1rem; color: var(--text-primary); width: 100%;">
                            <option value="">Select Centre</option>
                        </select>
                    </div>
                </div>
                <div class="input-group" style="margin-top: 1rem;">
                    <label>Default Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="add-password" required placeholder="Set temporary password">
                        <button type="button" class="toggle-btn"
                            onclick="togglePasswordVisibility('add-password', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="eye-icon">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="login-button" style="background: rgba(255,255,255,0.05); color: #fff;"
                        onclick="document.getElementById('add-user-modal').classList.remove('active')">Cancel</button>
                    <button type="submit" class="login-button">Save User</button>
                </div>
            </form>

            <!-- CSV Form -->
            <div id="csv-upload-section" class="tab-content"
                style="display: none; text-align: center; padding: 2rem 0;">
                <div class="upload-area"
                    style="border: 2px dashed var(--glass-border); border-radius: 1rem; padding: 3rem 2rem; transition: all 0.3s ease;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                        stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="margin-bottom: 1rem;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <h3 style="margin-bottom: 0.5rem;">Upload CSV File</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem;">Format: Name,
                        Email, Phone, Role, Password, Centre</p>

                    <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                    <button class="btn-add" onclick="document.getElementById('csv-file-input').click()">Select
                        File</button>
                    <div id="file-name-display"
                        style="margin-top: 1rem; font-size: 0.9rem; color: var(--accent-color); font-weight: 600;">
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="login-button" style="background: rgba(255,255,255,0.05); color: #fff;"
                        onclick="document.getElementById('add-user-modal').classList.remove('active')">Cancel</button>
                    <button id="process-csv-btn" class="login-button" disabled style="opacity: 0.5;">Upload &
                        Process</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Role Modal -->
    <div id="edit-role-modal" class="modal-overlay">
        <div class="login-card" style="max-width: 400px; position: relative;">
            <button class="modal-close-btn"
                onclick="document.getElementById('edit-role-modal').classList.remove('active')"
                aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="header">
                <h2>Edit Role</h2>
                <p>Change user permission level</p>
            </div>
            <form id="edit-role-form">
                <input type="hidden" id="edit-email-id">
                <div class="input-group">
                    <label>Selected User</label>
                    <div id="edit-user-display"
                        style="padding: 0.875rem 1rem; background: rgba(255,255,255,0.03); border-radius: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">
                    </div>
                </div>
                <div class="input-group" style="margin-top: 1.5rem;">
                    <label>New Role</label>
                    <select id="edit-role-select" onchange="toggleCentreField()"
                        style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 0.75rem; padding: 0.875rem 1rem; color: var(--text-primary); width: 100%;">
                        <option value="Students">Students</option>
                        <option value="Mentor">Mentor</option>
                        <option value="Admin">Admin</option>
                        <option value="Academics">Academics</option>
                        <option value="Super admin">Super admin</option>
                    </select>
                </div>
                <div class="input-group" id="edit-centre-group" style="margin-top: 1.5rem;">
                    <label id="edit-centre-label">Centre Name</label>
                    <select id="edit-centre-select" class="centre-selector"
                        style="background: rgba(15, 23, 42, 0.6); border: 1px solid var(--glass-border); border-radius: 0.75rem; padding: 0.875rem 1rem; color: var(--text-primary); width: 100%;">
                        <option value="">Select Centre</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" id="edit-submit-btn" class="login-button" style="flex: 1;">Update
                        Role</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile & Password Modal -->
    <div id="password-modal" class="modal-overlay">
        <div class="login-card" style="max-width: 500px; position: relative;">
            <button class="modal-close-btn"
                onclick="document.getElementById('password-modal').classList.remove('active')" aria-label="Close modal">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="header">
                <h2 id="pwd-modal-title">My Profile</h2>
                <p id="pwd-modal-desc">View your details and update your security settings.</p>
            </div>
            <form id="update-password-form">
                <div class="profile-details-stack"
                    style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
                    <div class="input-group">
                        <label>Name</label>
                        <input type="text" id="profile-name" readonly
                            style="opacity: 0.8; cursor: not-allowed; background: rgba(255,255,255,0.03); border: none;">
                    </div>
                    <div class="input-group">
                        <label>Email ID</label>
                        <input type="email" id="profile-email" readonly
                            style="opacity: 0.8; cursor: not-allowed; background: rgba(255,255,255,0.03); border: none;">
                    </div>
                    <div class="input-group">
                        <label>Phone Number</label>
                        <input type="text" id="profile-phone" readonly
                            style="opacity: 0.8; cursor: not-allowed; background: rgba(255,255,255,0.03); border: none;">
                    </div>
                </div>

                <div class="header" style="margin: 1.5rem 0 1rem 0; text-align: left; padding: 0;">
                    <h3 style="font-size: 1rem; color: var(--accent-color);">Change Password</h3>
                </div>

                <div class="input-group">
                    <label>New Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="new-password" required placeholder="••••••••">
                        <button type="button" class="toggle-btn"
                            onclick="togglePasswordVisibility('new-password', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="eye-icon">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="input-group">
                    <label>Confirm Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="confirm-password" required placeholder="••••••••">
                        <button type="button" class="toggle-btn"
                            onclick="togglePasswordVisibility('confirm-password', this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="eye-icon">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button type="submit" id="update-pwd-submit" class="login-button" style="flex: 1; opacity: 0.5;"
                        disabled>Update Password</button>
                </div>
            </form>
        </div>
    </div>

    <script src="supabase-init.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.querySelector('.sidebar');
            const toggleBtn = document.getElementById('sidebar-toggle-btn');
            toggleBtn?.addEventListener('click', () => {
                sidebar?.classList.toggle('collapsed');
            });
        });

        // Initialize Dynamic Centres
        const populateCentres = async () => {
            try {
                // 1. Try to get from the new Centres table
                let { data: centres, error } = await supabaseClient.from('Centres').select('name').order('name');

                // 2. Fallback to Access table if Centres table doesn't exist yet
                if (error || !centres || centres.length === 0) {
                    console.warn('Centres table not found, falling back to Access table unique values.');
                    const { data: accessData } = await supabaseClient.from('Access').select('centre_name');
                    if (accessData) {
                        const unique = [...new Set(accessData.map(u => u.centre_name).filter(Boolean))];
                        // Also include defaults if empty
                        if (unique.length === 0) unique.push('Delhi', 'Kolkata', 'Bhubaneswar');
                        centres = unique.sort().map(name => ({ name }));
                    }
                }

                if (centres) {
                    const addSel = document.getElementById('add-centre');
                    const editSel = document.getElementById('edit-centre-select');
                    const options = '<option value="">Select Centre</option>' + centres.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                    if (addSel) addSel.innerHTML = options;
                    if (editSel) editSel.innerHTML = options;
                }
            } catch (e) {
                console.error('Centre Population Error:', e);
            }
        };
        populateCentres();

        window.toggleCentreField = () => {
            // For Add Modal
            const addRole = document.getElementById('add-role')?.value;
            const addLabel = document.getElementById('centre-label');
            if (addRole === 'Students' && addLabel) {
                addLabel.innerHTML = 'Centre Name <span style="color: #ef4444;">*</span>';
            } else if (addLabel) {
                addLabel.innerHTML = 'Centre Name';
            }

            // For Edit Modal
            const editRole = document.getElementById('edit-role-select')?.value;
            const editLabel = document.getElementById('edit-centre-label');
            if (editRole === 'Students' && editLabel) {
                editLabel.innerHTML = 'Centre Name <span style="color: #ef4444;">*</span>';
            } else if (editLabel) {
                editLabel.innerHTML = 'Centre Name';
            }
        };

        let allUsers = [];

        window.toggleActionMenu = (e, email) => {
            e.stopPropagation();
            const menus = document.querySelectorAll('.action-menu');
            const targetId = `menu-${email.replace(/[@.]/g, '-')}`;

            menus.forEach(m => {
                if (m.id !== targetId) {
                    m.classList.remove('active');
                }
            });

            const menu = document.getElementById(targetId);
            if (menu) menu.classList.toggle('active');
        };

        window.deactivateUser = async (userId, currentIsActive) => {
            const newStatus = !currentIsActive;
            const action = newStatus ? 'activate' : 'deactivate';

            if (confirm(`Are you sure you want to ${action} this user?`)) {
                try {
                    // Update the status using the secure UUID
                    const { data, error } = await window.supabaseClient
                        .from('User_Status')
                        .update({ is_active: newStatus })
                        .eq('user_id', userId)
                        .select();

                    if (error) throw error;

                    if (!data || data.length === 0) {
                        throw new Error('Verification failed: Security record not found.');
                    }

                    alert(`Status updated successfully.`);
                    if (window.refreshUsers) await window.refreshUsers();
                    else window.location.reload();

                } catch (err) {
                    console.error('Update Error:', err);
                    alert('Error: ' + err.message);
                }
            }
        };

        window.resetPassword = async (email) => {
            if (confirm(`Are you sure you want to reset password for ${email}? This will send a secure password reset link to their email and force them to set a new password on login.`)) {
                // 1. Send the email via Supabase Auth
                const { error: authError } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '/dashboard.html',
                });

                if (authError) {
                    alert('Error sending reset email: ' + authError.message);
                    return;
                }

                // 2. Set the is_first_login flag to force our custom password modal locally
                const { error: dbError } = await supabaseClient
                    .from('Access')
                    .update({ is_first_login: true })
                    .eq('email_id', email);

                if (dbError) {
                    alert('Error updating user flag: ' + dbError.message);
                } else {
                    alert('Reset email sent successfully! The user will be prompted to set a new password when they follow the link.');
                    await window.refreshUsers();
                }
            }
        };

        window.updateEditSubmitState = () => {
            const role = document.getElementById('edit-role-select')?.value;
            const centre = document.getElementById('edit-centre-select')?.value;
            const btn = document.getElementById('edit-submit-btn');

            if (btn) {
                const isDisabled = role === 'Students' && !centre;
                btn.disabled = isDisabled;
                btn.style.opacity = isDisabled ? '0.5' : '1';
                btn.style.cursor = isDisabled ? 'not-allowed' : 'pointer';
            }
        };

        window.editRole = async (email) => {
            const user = allUsers.find(u => u.email_id === email);
            if (!user) return;

            document.getElementById('edit-email-id').value = email;
            document.getElementById('edit-user-display').textContent = `${user.name} (${email})`;
            document.getElementById('edit-role-select').value = user.role;
            document.getElementById('edit-centre-select').value = user.centre_name || '';

            toggleCentreField();
            window.updateEditSubmitState(); // Initial button state
            document.getElementById('edit-role-modal').classList.add('active');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            toggleCentreField();
            const usersBody = document.getElementById('users-body');
            const searchInput = document.getElementById('user-search');

            // Handle clicks outside to close menus
            document.addEventListener('click', () => {
                const menus = document.querySelectorAll('.action-menu');
                menus.forEach(m => m.classList.remove('active'));
            });

            const renderUsers = (usersToRender) => {
                usersBody.innerHTML = usersToRender.map(user => `
                    <tr>
                        <td><span style="font-weight: 600;">${user.name}</span></td>
                        <td>${user.email_id}</td>
                        <td><span class="role-badge">${user.role}</span></td>
                        <td style="color: var(--text-secondary);">${user.phone_number}</td>
                        <td style="color: var(--text-secondary);">${user.centre_name || '-'}</td>
                        <td>
                            <span class="status-badge ${user.is_active !== false ? 'status-active' : 'status-inactive'}">
                                <span class="status-dot"></span>
                                ${user.is_active !== false ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="action-cell">
                            <button class="three-dots-btn" onclick="toggleActionMenu(event, '${user.email_id}')">
                                <svg style="pointer-events: none;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                            </button>
                            <div class="action-menu" id="menu-${user.email_id.replace(/[@.]/g, '-')}">
                                <button class="action-menu-item" onclick="editRole('${user.email_id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                    Edit Role
                                </button>
                                <button class="action-menu-item" onclick="resetPassword('${user.email_id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
                                    Reset Password
                                </button>
                                <div class="dropdown-divider" style="margin: 0.25rem 0;"></div>
                                <button class="action-menu-item ${user.is_active !== false ? 'danger' : ''}" 
                                        onclick="deactivateUser('${user.user_id}', ${user.is_active !== false})">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg>
                                    ${user.is_active !== false ? 'Deactivate' : 'Activate'} User
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            };

            const fetchUsers = async () => {
                // Fetch joined data using UUID relationship
                const { data, error } = await supabaseClient
                    .from('Access')
                    .select('*, User_Status(is_active)')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Fetch Error:', error);
                    alert('Database Error: ' + error.message);
                    return;
                }

                if (data) {
                    // Mapping with fallback to 'true' if status is missing
                    allUsers = data.map(u => ({
                        ...u,
                        is_active: (u.User_Status && u.User_Status.is_active !== undefined) ? u.User_Status.is_active : true
                    }));
                    renderUsers(allUsers);
                    console.log('Users loaded:', allUsers.length);
                }
            };

            await fetchUsers();

            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allUsers.filter(user =>
                    (user.email_id && user.email_id.toLowerCase().includes(term)) ||
                    (user.phone_number && user.phone_number.toLowerCase().includes(term)) ||
                    (user.name && user.name.toLowerCase().includes(term))
                );
                renderUsers(filtered);
            });

            // Form submission
            const addForm = document.getElementById('add-user-form');
            addForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = addForm.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.textContent = 'Saving...';

                const newUser = {
                    name: document.getElementById('add-name').value,
                    email_id: document.getElementById('add-email').value,
                    phone_number: document.getElementById('add-phone').value,
                    role: document.getElementById('add-role').value,
                    password: document.getElementById('add-password').value,
                    centre_name: document.getElementById('add-centre').value,
                    is_first_login: true,
                    is_active: true
                };

                if (newUser.role === 'Students' && !newUser.centre_name) {
                    alert('Centre Name is mandatory for Students');
                    btn.disabled = false;
                    btn.textContent = 'Save User';
                    return;
                }

                // 1. Create Auth Account using a "Ghost Client" (Prevents session hijacking)
                const ghostSupabase = supabase.createClient(
                    'https://aobwkcjfhbruihkandlg.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvYndrY2pmaGJydWloa2FuZGxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMjE1MjAsImV4cCI6MjA4NzU5NzUyMH0.V7OdMoiiDuXIMOdoUDLlUMjdavSjObHpajb2gHh0E38',
                    { auth: { persistSession: false } }
                );

                const { data: authData, error: authError } = await ghostSupabase.auth.signUp({
                    email: newUser.email_id,
                    password: newUser.password,
                });

                if (authError) {
                    alert('Authentication Error: ' + authError.message);
                    btn.disabled = false;
                    btn.textContent = 'Save User';
                    return;
                }

                const authId = authData.user.id;
                newUser.user_id = authId;
                console.log('✅ Auth Account Created. ID:', authId);

                // 2. Initialize Status in the new Secure table using UUID
                const { error: statusError } = await supabaseClient.from('User_Status').insert([{
                    user_id: authId,
                    is_active: true
                }]);

                if (statusError) {
                    console.error('❌ Status Insert Failed:', statusError);
                    alert('Security Status Error: ' + statusError.message + '\n\nPlease ensure you ran the latest RLS SQL script.');
                    btn.disabled = false;
                    btn.textContent = 'Save User';
                    return;
                }
                console.log('✅ Security Status Initialized.');

                // 3. Insert into Access Table
                const { error: dbError } = await supabaseClient.from('Access').insert([newUser]);

                if (dbError) {
                    console.error('❌ Profile Insert Failed:', dbError);
                    alert('Database Error: ' + dbError.message);
                } else {
                    console.log('✅ User Profile Created.');
                    alert('User created successfully!');
                    document.getElementById('add-user-modal').style.display = 'none';
                    addForm.reset();
                    await fetchUsers();
                }
                btn.disabled = false;
                btn.textContent = 'Save User';
            });

            // Re-use logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await supabaseClient.auth.signOut();
                    window.location.replace('index.html');
                });
            }

            // Tab Switching Logic
            const tabManual = document.getElementById('tab-manual');
            const tabCsv = document.getElementById('tab-csv');
            const manualForm = document.getElementById('add-user-form');
            const csvSection = document.getElementById('csv-upload-section');

            tabManual.addEventListener('click', () => {
                tabManual.classList.add('active');
                tabManual.style.borderBottom = '2px solid var(--accent-color)';
                tabManual.style.color = 'var(--accent-color)';
                tabCsv.classList.remove('active');
                tabCsv.style.borderBottom = 'none';
                tabCsv.style.color = 'var(--text-secondary)';
                manualForm.style.display = 'block';
                csvSection.style.display = 'none';
            });

            tabCsv.addEventListener('click', () => {
                tabCsv.classList.add('active');
                tabCsv.style.borderBottom = '2px solid var(--accent-color)';
                tabCsv.style.color = 'var(--accent-color)';
                tabManual.classList.remove('active');
                tabManual.style.borderBottom = 'none';
                tabManual.style.color = 'var(--text-secondary)';
                manualForm.style.display = 'none';
                csvSection.style.display = 'block';
            });

            // CSV File Handling
            const fileInput = document.getElementById('csv-file-input');
            const fileNameDisplay = document.getElementById('file-name-display');
            const processBtn = document.getElementById('process-csv-btn');
            let parsedUsers = [];

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = `Selected: ${file.name}`;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const content = event.target.result;
                        const lines = content.split('\n');
                        parsedUsers = lines.slice(1) // Skip header
                            .filter(line => line.trim() !== '')
                            .map(line => {
                                const [name, email, phone, role, password, centre, status] = line.split(',').map(s => s.trim());
                                return {
                                    name,
                                    email_id: email,
                                    phone_number: phone,
                                    role,
                                    password,
                                    centre_name: centre,
                                    is_first_login: true,
                                    is_active: status ? (status.toLowerCase() === 'true' || status === '1') : true
                                };
                            });

                        if (parsedUsers.length > 0) {
                            processBtn.disabled = false;
                            processBtn.style.opacity = '1';
                            processBtn.textContent = `Upload ${parsedUsers.length} Users`;
                        }
                    };
                    reader.readAsText(file);
                }
            });

            processBtn.addEventListener('click', async () => {
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';

                let successCount = 0;
                let errorCount = 0;

                // For bulk upload, we must create Auth accounts for all.
                // We do this sequentially to avoid rate limits and session issues.
                for (const user of parsedUsers) {
                    try {
                        // Create Auth Account
                        const { error: authErr } = await supabaseClient.auth.signUp({
                            email: user.email_id,
                            password: user.password
                        });

                        if (authErr) {
                            console.error(`Auth failed for ${user.email_id}:`, authErr.message);
                            errorCount++;
                            continue;
                        }

                        // Create Access Record
                        const { error: dbErr } = await supabaseClient.from('Access').insert([user]);
                        if (dbErr) {
                            console.error(`DB failed for ${user.email_id}:`, dbErr.message);
                            errorCount++;
                        } else {
                            successCount++;
                        }
                    } catch (err) {
                        errorCount++;
                    }
                }

                alert(`Process Finished!\nSuccess: ${successCount}\nErrors: ${errorCount}`);

                if (successCount > 0) {
                    document.getElementById('add-user-modal').style.display = 'none';
                    fileInput.value = '';
                    fileNameDisplay.textContent = '';
                    processBtn.disabled = true;
                    processBtn.style.opacity = '0.5';
                    await fetchUsers();
                }

                processBtn.textContent = 'Upload & Process';
                processBtn.disabled = errorCount === 0;
            });

            // Profile Dropdown Toggle
            const profileBtn = document.getElementById('user-profile-btn');
            if (profileBtn) {
                profileBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    profileBtn.classList.toggle('active');
                });
            }
            document.addEventListener('click', () => profileBtn?.classList.remove('active'));

            // Open Profile Modal manually
            document.getElementById('open-profile-btn')?.addEventListener('click', async (e) => {
                e.preventDefault();

                // Fetch current user details for the modal
                const { data: { session } } = await supabaseClient.auth.getSession();
                const { data: profileData } = await supabaseClient
                    .from('Access')
                    .select('name, phone_number, email_id')
                    .eq('email_id', session.user.email)
                    .single();

                if (profileData) {
                    document.getElementById('profile-name').value = profileData.name || '';
                    document.getElementById('profile-email').value = profileData.email_id || session.user.email;
                    document.getElementById('profile-phone').value = profileData.phone_number || '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    updateSubmitState();
                }

                document.getElementById('pwd-modal-title').textContent = "My Profile";
                document.getElementById('pwd-modal-desc').textContent = "View your details and update your security settings.";
                document.getElementById('password-modal').classList.add('active');
            });

            // Handle Password Update in Profile Modal
            const updatePwdForm = document.getElementById('update-password-form');
            const newPwdInput = document.getElementById('new-password');
            const confirmPwdInput = document.getElementById('confirm-password');
            const submitBtn = document.getElementById('update-pwd-submit');

            const updateSubmitState = () => {
                const hasContent = newPwdInput.value.trim() !== '' && confirmPwdInput.value.trim() !== '';
                submitBtn.disabled = !hasContent;
                submitBtn.style.opacity = hasContent ? '1' : '0.5';
            };

            newPwdInput?.addEventListener('input', updateSubmitState);
            confirmPwdInput?.addEventListener('input', updateSubmitState);

            if (updatePwdForm) {
                updatePwdForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newPwd = document.getElementById('new-password').value;
                    const confirmPwd = document.getElementById('confirm-password').value;

                    if (newPwd !== confirmPwd) return alert("Passwords do not match!");

                    const btn = updatePwdForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    btn.textContent = 'Updating...';

                    const { data: { session: currentSession } } = await supabaseClient.auth.getSession();
                    const result = await window.updatePasswordWithBio(newPwd, currentSession.user.email);

                    if (result.success) {
                        alert('Password updated successfully! Please login with your new password.');
                        await supabaseClient.auth.signOut();
                        window.location.replace('index.html');
                    } else {
                        alert('Error: ' + result.message);
                        btn.disabled = false;
                        btn.textContent = 'Update Password';
                    }
                });
            }

            // Detect if first login is needed on page load
            const checkFirstLogin = async () => {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    const { data: userData } = await supabaseClient
                        .from('Access')
                        .select('is_first_login')
                        .eq('email_id', session.user.email)
                        .single();

                    if (userData?.is_first_login) {
                        // Trigger modal open
                        document.getElementById('open-profile-btn')?.click();
                        // Disable close for force
                        const closeBtn = document.querySelector('.modal-close-btn');
                        if (closeBtn) closeBtn.style.display = 'none';
                    }
                }
            };
            checkFirstLogin();

            // Edit Role Form Listeners for Button state
            const editRoleSelect = document.getElementById('edit-role-select');
            const editCentreSelect = document.getElementById('edit-centre-select');

            editRoleSelect?.addEventListener('change', window.updateEditSubmitState);
            editCentreSelect?.addEventListener('change', window.updateEditSubmitState);

            // Handle Role Update
            const editRoleForm = document.getElementById('edit-role-form');
            if (editRoleForm) {
                editRoleForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('edit-email-id').value;
                    const newRole = document.getElementById('edit-role-select').value;
                    const newCentre = document.getElementById('edit-centre-select').value;

                    if (newRole === 'Students' && !newCentre) {
                        alert('Centre Name is mandatory for Students');
                        return;
                    }

                    const btn = editRoleForm.querySelector('button[type="submit"]');
                    btn.disabled = true;
                    btn.textContent = 'Updating...';

                    const { error } = await supabaseClient
                        .from('Access')
                        .update({
                            role: newRole,
                            centre_name: newCentre
                        })
                        .eq('email_id', email);

                    if (error) {
                        alert('Error updating role: ' + error.message);
                    } else {
                        alert('Role updated successfully!');
                        document.getElementById('edit-role-modal').classList.remove('active');
                        await window.refreshUsers(); // Helper to re-fetch
                    }
                    btn.disabled = false;
                    btn.textContent = 'Update Role';
                });
            }

            // Expose refresh function
            window.refreshUsers = fetchUsers;

            // Logout Logic
            // (Already handled in the top section of script)
        });
    </script>
</body>

</html>